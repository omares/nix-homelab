# Scrypted

Scrypted is a home automation platform focused on cameras and video management.

The goal of this package is to pre-provision Scrypted and its plugins to adhere to Nix's reproducibility principle - fetching dependencies at build time, not runtime.
As Scrypted is designed with full control over the underlying machine and internet access in mind - a fundamentally different approach from Nix's hermetic builds - this package is work in progress trying to align both worlds.

Note: This installation method is not officially supported by Scrypted.


## Main Package

The main package (`package.nix`) builds the Scrypted server with all necessary runtime dependencies pre-configured.

**Runtime Environment**
The package bundles Node.js as the JavaScript runtime, Python with pip, setuptools, wheel, and debugpy for plugin Python environments, FFmpeg for video processing and transcoding, and Bash for interactive shell operations.


**Environment Variables**
The wrapper sets `SCRYPTED_PYTHON_PATH` and `SCRYPTED_PYTHON312_PATH` to the Python interpreter, `SCRYPTED_FFMPEG_PATH` to the FFmpeg binary, and `SHELL` to Bash for interactive operations.


**Runtime Libraries**
Required libraries are injected via `LD_LIBRARY_PATH`: `libstdc++` for pip-installed Python packages like numpy and openvino, `zlib` for compression, and on Linux `libdrm` for GPU access and `libva` for VA-API hardware video acceleration. Additionally, `/run/opengl-driver/lib` is included for Intel OpenCL/OpenGL libraries (populated by `hardware.graphics.extraPackages`).

**node-pty Patch**
Scrypted uses `@scrypted/node-pty` which depends on `@scrypted/prebuild-install`. This attempts to download prebuilt binaries during `npm install`, which fails in Nix's sandbox (no network access during build).

The package patches this by replacing `@scrypted/node-pty` with the official `node-pty` package, which uses `node-addon-api` and compiles from source instead of downloading prebuilt binaries.

**install.json**
An `install.json` file is generated containing the package version. Scrypted uses this to detect its installed version and skip self-update checks.

## (Autogenerated) Plugins

All available plugins are in the [`plugins/`](./plugins) directory.
Most plugins are auto-generated from the npm registry using:

```bash
./plugins-update.sh
```

### Complex Plugins

These plugins require custom or extended building (e.g., Python environments) and are not auto-generated. They come with their own `update.sh`:

- `openvino` - OpenVINO inference with pre-provisioned Python environment. **Note:** Unfortunately, Hugging Face ML models are not provisioned due to the complexity of downloading and saving them correctly. Scrypted dynamically generates the target folder based on the worker ID and expects the files to be there. As a result, the plugin requires internet access to acquire the models. :(

```bash
./plugins/openvino/update.sh
```

### Skipped/Ignored Plugins

These plugins have not been investigated/implemented yet:

- `arlo`, `blink`, `wyze`
- `coreml`, `ncnn`, `onnx`, `opencv`, `rknn`
- `kokoro`, `python-codecs`, `x11-camera`
- `notifier-zone-filter`, `smtp-notifier`
- `rockchip-essentials`
- `tensorflow-lite`

### mkScryptedPlugin

`mkScryptedPlugin` is a builder function for packaging existing Scrypted plugins from the npm registry.

```nix
{ mkScryptedPlugin }:

mkScryptedPlugin {
  pname = "scrypted-plugin-name";
  version = "1.0.0"; # npm version
  hash = "sha256-...";

  # Optional: function receiving finalAttrs for self-reference
  passthru = finalAttrs: {
    # Expose provisioning data for detection plugins
    provision = {
      warnings = [ "Requires network access" ];
      symlinks = [{
        target = "directory-name";
        path = "${finalAttrs.finalPackage}/some-path";
      }];
    };
  };

  meta.description = "My plugin description";
}
```

The builder:
- Downloads plugin tarball from npm registry
- Extracts `package.json` and `plugin.zip` for sideload API
- Sets `passthru.pluginName` to `@scrypted/<pname>`

## NixOS Module

For NixOS service configuration, see [`modules/automation/scrypted/`](../../modules/automation/scrypted/).
