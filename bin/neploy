#!/usr/bin/env bash
# NixOS deployment helper with nom output

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FLAKE_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
NC='\033[0m'

# Verbosity (0=normal, 1=verbose, 2=very verbose)
VERBOSITY=0

show_help() {
  echo "Usage: neploy [options] <targets...>"
  echo "       neploy [options] group <name|all>"
  echo ""
  echo "Options:"
  echo "  -v           Verbose (nix verbose output)"
  echo "  -vv          Very verbose (nix + deploy-rs debug)"
  echo "  -h, --help   Show help"
  echo ""
  echo "Examples:"
  echo "  neploy .#dns-01              Deploy single node"
  echo "  neploy .#dns-01 .#dns-02     Deploy multiple nodes"
  echo "  neploy group dns             Deploy group"
  echo "  neploy group all             Deploy all groups"
  echo "  neploy -v group starr        Verbose group deploy"
}

# Get nodes for a deploy group from flake
get_group_nodes() {
  local group="$1"
  nix eval "$FLAKE_ROOT#deployGroups.$group" --json 2>/dev/null | \
    jq -r '.[]' | sed 's/^/.#/'
}

# List available groups
list_groups() {
  echo "Available deploy groups:"
  nix eval "$FLAKE_ROOT#deployGroups" --json 2>/dev/null | \
    jq -r 'to_entries[] | "  \(.key) - \(.value | join(", "))"'
}

# Deploy a single target
deploy_target() {
  local target="$1"
  local nix_args=""
  local deploy_args="-s"
  local filter_copy=true

  [[ $VERBOSITY -ge 1 ]] && nix_args="-v" && filter_copy=false
  [[ $VERBOSITY -ge 2 ]] && deploy_args="-s -d"

  echo -e "${BLUE}>>>${NC} Deploying: ${GREEN}${target}${NC}"
  
  if $filter_copy; then
    # Filter out verbose "copying path" lines from nix copy (not JSON formatted by deploy-rs)
    deploy "$target" $deploy_args -- --log-format internal-json $nix_args 2>&1 \
      | grep -v "^copying path '" \
      | nom --json
  else
    # Full verbose output (includes copy paths)
    deploy "$target" $deploy_args -- --log-format internal-json $nix_args |& nom --json
  fi
}

# Deploy multiple targets sequentially
deploy_targets() {
  for target in "$@"; do
    deploy_target "$target"
  done
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -vv)       VERBOSITY=2; shift ;;
    -v)        VERBOSITY=1; shift ;;
    -h|--help) show_help; exit 0 ;;
    *)         break ;;
  esac
done

# Main logic
case "${1:-}" in
  group)
    case "${2:-}" in
      ""|--help|-h)
        list_groups
        ;;
      all)
        for group in infra build starr nvr; do
          echo ""
          echo -e "${BLUE}===${NC} Group: ${GREEN}${group}${NC} ${BLUE}===${NC}"
          echo ""
          mapfile -t nodes < <(get_group_nodes "$group")
          deploy_targets "${nodes[@]}"
        done
        ;;
      *)
        mapfile -t nodes < <(get_group_nodes "$2")
        if [ ${#nodes[@]} -eq 0 ]; then
          echo "Error: Unknown group '$2'"
          echo ""
          list_groups
          exit 1
        fi
        deploy_targets "${nodes[@]}"
        ;;
    esac
    ;;
  ""|--help|-h)
    show_help
    ;;
  *)
    deploy_targets "$@"
    ;;
esac
