#!/usr/bin/env bash
# NixOS deployment helper using deploy-rs

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FLAKE_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors
BOLD='\033[1m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

# Verbosity (0=normal, 1=verbose, 2=very verbose, 3=maximum)
VERBOSITY=0
DEPLOY_ALL=false
INIT_MODE=false
SHOW_COMPLETION=false
GET_NODES=false
GET_TAGS=false

show_help() {
  echo "Usage: d [options] <targets...>"
  echo "       d [options] tag <name>"
  echo "       d [options] --all"
  echo ""
  echo "Options:"
  echo "  -i, --init     First-time deployment (prompts for sudo password)"
  echo "  -v             Verbose (nix -v)"
  echo "  -vv            Very verbose (nix -vv, deploy-rs debug)"
  echo "  -vvv           Maximum verbosity (nix -vvv, deploy-rs debug)"
  echo "  -a, --all      Deploy all tagged nodes"
  echo "  --completion   Output zsh completion script"
  echo "  --get-nodes    List all node names (for completion)"
  echo "  --get-tags     List all tag names (for completion)"
  echo "  -h, --help     Show help"
  echo ""
  echo "Examples:"
  echo "  d dns-01                Deploy single node (auto-prefixed)"
  echo "  d .#dns-01              Deploy single node (explicit prefix)"
  echo "  d dns-01 dns-02         Deploy multiple nodes"
  echo "  d tag starr             Deploy nodes with 'starr' tag"
  echo "  d --all                 Deploy all tagged nodes"
  echo "  d -v tag infra          Verbose deploy"
  echo "  d -vvv dns-01           Maximum verbosity"
  echo "  d --init mqtt-01        First-time deploy (interactive sudo)"
}

# Get all node names from flake
get_all_nodes() {
  nix eval "$FLAKE_ROOT#nodes" --json 2>/dev/null | jq -r '.[]'
}

# Get nodes for a tag from flake
get_tag_nodes() {
  local tag="$1"
  nix eval "$FLAKE_ROOT#tags.$tag" --json 2>/dev/null | \
    jq -r '.[]' | sed 's/^/.#/'
}

# Get all tag names from flake
get_all_tags() {
  nix eval "$FLAKE_ROOT#tags" --json 2>/dev/null | jq -r 'keys[]'
}

# List available tags
list_tags() {
  echo "Available tags:"
  nix eval "$FLAKE_ROOT#tags" --json 2>/dev/null | \
    jq -r $'to_entries[] | "  \(.key): \(.value | join(\", \"))"'
}

# Deploy a single target
deploy_target() {
  local target="$1"
  local tag="${2:-}"
  local nix_args=""
  local deploy_args="-s"

  [[ $INIT_MODE == true ]] && deploy_args="$deploy_args --interactive-sudo true"
  [[ $VERBOSITY -ge 1 ]] && nix_args="-v"
  [[ $VERBOSITY -ge 2 ]] && nix_args="-vv" && deploy_args="$deploy_args -d"
  [[ $VERBOSITY -ge 3 ]] && nix_args="-vvv"

  local name="${target#.}"
  local tag_suffix=""
  [[ -n "$tag" ]] && tag_suffix="  üè∑Ô∏è  ${tag}"

  # Calculate padding (üì°=1char/2wide, üè∑Ô∏è=2chars/2wide)
  local extra_width=1  # üì° is 1 char but 2 wide
  [[ -n "$tag_suffix" ]] && extra_width=1  # üè∑Ô∏è is 2 chars but 2 wide, so no extra
  local content="  X ${name}${tag_suffix}  "
  local width=64
  local padding=$((width - ${#content} - extra_width))
  [[ $padding -lt 0 ]] && padding=0
  local spaces=$(printf '%*s' "$padding" '')

  echo ""
  echo -e "${CYAN}‚ï≠$(printf '‚îÄ%.0s' $(seq 1 $width))‚ïÆ${NC}"
  echo -e "${CYAN}‚îÇ${NC}  üì° ${BOLD}${GREEN}${name}${NC}${tag_suffix}${spaces}  ${CYAN}‚îÇ${NC}"
  echo -e "${CYAN}‚ï∞$(printf '‚îÄ%.0s' $(seq 1 $width))‚ïØ${NC}"
  echo ""

  if [[ -n "$nix_args" ]]; then
    deploy "$target" $deploy_args -- $nix_args
  else
    deploy "$target" $deploy_args
  fi
}

# Deploy multiple targets sequentially
deploy_targets() {
  local tag="${1:-}"
  shift || true
  for target in "$@"; do
    deploy_target "$target" "$tag"
  done
}

# Deploy all tagged nodes
deploy_all() {
  local all_tags
  mapfile -t all_tags < <(get_all_tags)

  for tag in "${all_tags[@]}"; do
    mapfile -t nodes < <(get_tag_nodes "$tag")
    deploy_targets "$tag" "${nodes[@]}"
  done
}

# Output zsh completion script
output_completion() {
  cat <<'EOF'
#compdef d
# zsh completion script for nix-proxmox deployment wrapper
# Save this file as _d in your fpath directory

_d() {
  local curcontext="$curcontext" state line
  typeset -A opt_args

  # Get available tags and nodes
  local -a tags nodes flags
  local script_path="/Users/ota/development/omares/nix-proxmox/bin/d"
  tags=($($script_path --get-tags 2>/dev/null))
  nodes=($($script_path --get-nodes 2>/dev/null))
  flags=(-i --init -v -vv -vvv -a --all -h --help --completion --get-nodes --get-tags)

  # Check if we're completing after 'tag' command
  if [[ ${words[CURRENT-1]} == "tag" ]]; then
    _describe -t tags 'tags' tags
    return 0
  fi

  # Check if we're completing a flag argument
  if [[ ${words[CURRENT-1]} == -* ]]; then
    _describe -t commands 'commands' nodes
    return 0
  fi

  _arguments -C \
    '-i[First-time deployment (prompts for sudo password)]' \
    '--init[First-time deployment (prompts for sudo password)]' \
    '-v[Verbose (nix -v)]' \
    '-vv[Very verbose (nix -vv)]' \
    '-vvv[Maximum verbosity (nix -vvv)]' \
    '-a[Deploy all tagged nodes]' \
    '--all[Deploy all tagged nodes]' \
    '-h[Show help]' \
    '--help[Show help]' \
    '1: :->cmds' \
    '*:: :->nodes'

  case "$state" in
    cmds)
      _describe -t commands 'commands' "(tag:tag)"
      _describe -t nodes 'nodes' nodes
      ;;
    nodes)
      _describe -t nodes 'nodes' nodes
      ;;
  esac
}

compdef _d d
EOF
}

# Normalize target - add .# prefix if missing
normalize_target() {
  local target="$1"
  if [[ ! "$target" =~ ^\.# ]]; then
    echo ".#$target"
  else
    echo "$target"
  fi
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -vvv)       VERBOSITY=3; shift ;;
    -vv)        VERBOSITY=2; shift ;;
    -v)         VERBOSITY=1; shift ;;
    -i|--init)  INIT_MODE=true; shift ;;
    -a|--all)   DEPLOY_ALL=true; shift ;;
    --completion) SHOW_COMPLETION=true; shift ;;
    --get-nodes) GET_NODES=true; shift ;;
    --get-tags)  GET_TAGS=true; shift ;;
    -h|--help)  show_help; exit 0 ;;
    *)          break ;;
  esac
done

# Handle completion output
if $SHOW_COMPLETION; then
  output_completion
  exit 0
fi

# Handle get-nodes
if $GET_NODES; then
  get_all_nodes
  exit 0
fi

# Handle get-tags
if $GET_TAGS; then
  get_all_tags
  exit 0
fi

# Main logic
if $DEPLOY_ALL; then
  deploy_all
  exit 0
fi

case "${1:-}" in
  tag)
    case "${2:-}" in
      ""|--help|-h)
        list_tags
        ;;
      *)
        mapfile -t nodes < <(get_tag_nodes "$2")
        if [ ${#nodes[@]} -eq 0 ]; then
          echo "Error: Unknown tag '$2'"
          echo ""
          list_tags
          exit 1
        fi
        deploy_targets "$2" "${nodes[@]}"
        ;;
    esac
    ;;
  ""|--help|-h)
    show_help
    ;;
  *)
    # Normalize all targets (add .# prefix if missing)
    normalized_targets=()
    for target in "$@"; do
      normalized_targets+=("$(normalize_target "$target")")
    done
    deploy_targets "" "${normalized_targets[@]}"
    ;;
esac
